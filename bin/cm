#!/usr/bin/env perl6
use v6;

use Panda;
use Crystal::Maiden;
use Module::Rebuild;

sub help() {
    say '
    Crystal Maiden for Perl6 v.0.0.1

      - cm --help to get this message
      
      - cm <packagename>
        Will generate Gentoo ebuild for package
      
      - cm src
        configure - prints default install path
        compile - compile to blib
        test - run tests with prove
        install - install package
        
      - module
        list - list all modules
        rebuild - rebuild all perl6 modules
    ';
    }
sub MAIN(*@args, Bool :$help = False, Str :$overlay is copy) {
    if $help { help() }
    else {
        if !@args { help() }
        elsif @args[0] eq "src" {
            if @args[1] eq "configure" {
                printlibpath() }
            elsif @args[1] eq "compile" {
                pandacompile() }
            elsif @args[1] eq "test" {
                run <prove -e perl6 -r t/> }
            elsif @args[1] eq "install" {
                pandainstall(@args[2]) }
            }
        elsif @args[0] eq "module" {
            if @args[1] eq "list" {
                my $pandadir = %*CUSTOM_LIB<site> ~ '/panda';
                list(panda => Panda.new(
                    srcdir       => "$pandadir/src",
                    destdir      =>  'CRYSTAL MAIDEN',
                    statefile    => "$pandadir/state",
                    projectsfile => "$pandadir/projects.json"
                    )) }
            elsif @args[1] eq "rebuild" {
                rebuild() }
            }
        else {
            my $pandadir = %*CUSTOM_LIB<site> ~ '/panda';
            unless $overlay.defined {
                $overlay = '/usr/home/gentoo-perl6'
                }
            projectinfo(Panda.new(
                srcdir       => "$pandadir/src",
                destdir      =>  'CRYSTAL MAIDEN',
                statefile    => "$pandadir/state",
                projectsfile => "$pandadir/projects.json"
                ), $overlay, @args);
            }
        }
    }
